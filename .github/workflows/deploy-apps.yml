name: Deploy applications

on:
  push:
    branches:
      - main
    paths:
      - 'apps/**'
      - 'k6/**'
      - '.github/workflows/deploy-apps.yml'
      - 'Makefile'
  workflow_dispatch:
    inputs:
      helmfile_env:
        description: 'Value for HELMFILE_ENVIRONMENT'
        required: false
        default: 'default'
      run_k6:
        description: 'Run k6 test suite after helmfile apply'
        required: false
        default: 'true'
permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: us-east-1
  HELMFILE_ENVIRONMENT: ${{ github.event.inputs.helmfile_env || 'default' }}
  PUBLIC_HOSTED_ZONE: ${{ secrets.PUBLIC_HOSTED_ZONE }}
  PUBLIC_HOSTED_ZONE_ID: ${{ secrets.PUBLIC_HOSTED_ZONE_ID }}
  ACME_EMAIL: ${{ secrets.ACME_EMAIL }}
  CERT_MANAGER_IAM_ROLE_ARN: ${{ secrets.CERT_MANAGER_IAM_ROLE_ARN }}
  EXTERNAL_DNS_IAM_ROLE_ARN: ${{ secrets.EXTERNAL_DNS_IAM_ROLE_ARN }}
  LOKI_IAM_ROLE_ARN: ${{ secrets.LOKI_IAM_ROLE_ARN }}
  TEMPO_IAM_ROLE_ARN: ${{ secrets.TEMPO_IAM_ROLE_ARN }}
  GRAFANA_IAM_ROLE_ARN: ${{ secrets.GRAFANA_IAM_ROLE_ARN }}
  LOKI_S3_BUCKET: ${{ secrets.LOKI_S3_BUCKET }}
  TEMPO_S3_BUCKET: ${{ secrets.TEMPO_S3_BUCKET }}
  GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  BASE_URL: https://whoami.${{ secrets.PUBLIC_HOSTED_ZONE }}

jobs:
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.30.0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Setup Helmfile
        uses: mamezou-tech/setup-helmfile@v1
        with:
          helmfile-version: v0.158.0

      - name: Validate Helmfile environment variables
        run: |
          set -euo pipefail
          required_vars=(
            PUBLIC_HOSTED_ZONE
            PUBLIC_HOSTED_ZONE_ID
            ACME_EMAIL
            CERT_MANAGER_IAM_ROLE_ARN
            EXTERNAL_DNS_IAM_ROLE_ARN
            LOKI_IAM_ROLE_ARN
            TEMPO_IAM_ROLE_ARN
            GRAFANA_IAM_ROLE_ARN
            LOKI_S3_BUCKET
            TEMPO_S3_BUCKET
            GRAFANA_ADMIN_PASSWORD
            SLACK_WEBHOOK_URL
          )
          missing=()
          for var in "${required_vars[@]}"; do
            if [ -z "${!var:-}" ]; then
              missing+=("$var")
            fi
          done
          if [ "${#missing[@]}" -ne 0 ]; then
            printf '::error::Missing required environment variables: %s\n' "${missing[*]}"
            exit 1
          fi

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name ${{ secrets.AWS_EKS_CLUSTER_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Helmfile apply
        working-directory: apps
        env:
          HELMFILE_ENVIRONMENT: ${{ env.HELMFILE_ENVIRONMENT }}
        run: |
          set -euo pipefail
          helmfile --environment "$HELMFILE_ENVIRONMENT" apply

      - name: Run k6 tests
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.run_k6 != 'false' }}
        env:
          BASE_URL: ${{ env.BASE_URL }}
        run: |
          set -euo pipefail
          mkdir -p artifacts
          if compgen -G "k6/*.js" > /dev/null; then
            for script in k6/*.js; do
              name=$(basename "$script" .js)
              echo "Running k6 script: $script"
              k6 run "$script" \
                --summary-export "artifacts/${name}-summary.json" \
                -e BASE_URL="$BASE_URL"
            done
          else
            echo "No k6 scripts found in k6/."
          fi

      - name: Upload k6 summaries
        if: ${{ (github.event_name != 'workflow_dispatch' || github.event.inputs.run_k6 != 'false') && success() }}
        uses: actions/upload-artifact@v4
        with:
          name: k6-summaries
          path: artifacts/*.json
